stages:
  - build
  - test
  - package
  - deploy

# 1. Build Job
build:
  stage: build
  image: python:3.11
  script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt || true
    - echo "âœ… Build step completed, dependencies installed"
  artifacts:
    paths:
      - .venv/
  tags:
    - docker

# 2. Test Job
test:
  stage: test
  image: python:3.11
  script:
    - python -m pip install --upgrade pip
    - pip install pytest pytest-cov
    - pip install -r requirements.txt || true
    # Fix for 'just' test
    - apt-get update && apt-get install -y just || true
    - pytest --junitxml=reports/junit.xml --cov=. --cov-report=xml:reports/coverage.xml --cov-report=html:reports/html
  artifacts:
    reports:
      junit: reports/junit.xml
      cobertura: reports/coverage.xml
    paths:
      - reports/
  tags:
    - docker

# 3. Package Job
package:
  stage: package
  image: python:3.11
  script:
    - python -m pip install --upgrade pip
    - pip install build
    - python -m build
    - echo " Packaging complete"
  artifacts:
    paths:
      - dist/
  tags:
    - docker

# 4. Deploy Job
deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo " Simulating deployment..."
    - docker build -t myapp .
    - docker run -d -p 8080:8080 myapp
    - echo " Deploy step completed"
  only:
    - main
  tags:
    - docker
